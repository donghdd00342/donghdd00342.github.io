(function(){var t,e,i,n,r,o,s,a,h,c,u,l,d,g,f,p,m,y,b,v,x,w,D,M,P,R,S,I,B,L={}.hasOwnProperty,C=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1},k=[].slice;D=Array.prototype.slice,t=function(t,e){return null==e&&(e=document),"object"==typeof t||"undefined"!=typeof exports&&null!==exports?t:e.querySelector(t)},x=function(){function t(){}var e;return t.uniqid=(e=0,{get:function(){return e++}}),t.extend=function(t){var e,i,n,r,o,s;for(i=t,o=0,s=(r=D.call(arguments,1)).length;o<s;o++)for(n in e=r[o])L.call(e,n)&&(i[n]=e[n]);return i},t.clampRGB=function(t){return t<0?0:t>255?255:t},t.copyAttributes=function(t,e,i){var n,r,o,s,a;for(null==i&&(i={}),a=[],r=0,o=(s=t.attributes).length;r<o;r++)n=s[r],null!=i.except&&C.call(i.except,n.nodeName)>=0||a.push(e.setAttribute(n.nodeName,n.nodeValue));return a},t.dataArray=function(t){return null==t&&(t=0),r.NodeJS||null!=window.Uint8Array?new Uint8Array(t):new Array(t)},t}(),"undefined"!=typeof exports&&null!==exports?(b=exports,s=require("canvas"),d=s.Image,c=require("fibers"),w=require("fs")):b=window,b.Caman=r=function(){function i(){var t,n,r,o=this;if(0===arguments.length)throw"Invalid arguments";return this instanceof i?(this.finishInit=this.finishInit.bind(this),this.imageLoaded=this.imageLoaded.bind(this),t=arguments[0],i.NodeJS||(r=parseInt(i.getAttrId(t[0]),10),n="function"==typeof t[1]?t[1]:"function"==typeof t[2]?t[2]:function(){},isNaN(r)||!v.has(r))?(this.id=x.uniqid.get(),this.initializedPixelData=this.originalPixelData=null,this.cropCoordinates={x:0,y:0},this.cropped=!1,this.resized=!1,this.pixelStack=[],this.layerStack=[],this.canvasQueue=[],this.currentLayer=null,this.scaled=!1,this.analyze=new e(this),this.renderer=new y(this),this.domIsLoaded(function(){return o.parseArguments(t),o.setup()}),this):v.execute(r,n)):new i(arguments)}return i.version={release:"4.1.1",date:"4/8/2013"},i.DEBUG=!1,i.NodeJS="undefined"!=typeof exports&&null!==exports,i.autoload=!i.NodeJS,i.allowRevert=!0,i.crossOrigin="anonymous",i.toString=function(){return"Version "+i.version.release+", Released "+i.version.date},i.remoteProxy="",i.proxyParam="camanProxyUrl",i.getAttrId=function(e){return!!i.NodeJS||("string"==typeof e&&(e=t(e)),null==e||null==e.getAttribute?null:e.getAttribute("data-caman-id"))},i.prototype.domIsLoaded=function(t){var e=this;return i.NodeJS?setTimeout(function(){return t.call(e)},0):"complete"===document.readyState?(f.debug("DOM initialized"),setTimeout(function(){return t.call(e)},0)):document.addEventListener("readystatechange",function(){if("complete"===document.readyState)return f.debug("DOM initialized"),t.call(e)},!1)},i.prototype.parseArguments=function(t){var e,i,n;if(0===t.length)throw"Invalid arguments given";if(this.initObj=null,this.initType=null,this.imageUrl=null,this.callback=function(){},this.setInitObject(t[0]),1!==t.length){switch(typeof t[1]){case"string":this.imageUrl=t[1];break;case"function":this.callback=t[1]}if(2!==t.length&&(this.callback=t[2],4===t.length)){for(e in n=[],i=t[4])L.call(i,e)&&n.push(this.options[e]=i[e]);return n}}},i.prototype.setInitObject=function(e){if(i.NodeJS)return this.initObj=e,void(this.initType="node");if(this.initObj="object"==typeof e?e:t(e),null==this.initObj)throw"Could not find image or canvas for initialization.";return this.initType=this.initObj.nodeName.toLowerCase()},i.prototype.setup=function(){switch(this.initType){case"node":return this.initNode();case"img":return this.initImage();case"canvas":return this.initCanvas()}},i.prototype.initNode=function(){var t=this;return f.debug("Initializing for NodeJS"),this.image=new d,this.image.onload=function(){return f.debug("Image loaded. Width = "+t.imageWidth()+", Height = "+t.imageHeight()),t.canvas=new s(t.imageWidth(),t.imageHeight()),t.finishInit()},this.image.onerror=function(t){throw t},this.image.src=this.initObj},i.prototype.initImage=function(){return this.image=this.initObj,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),x.copyAttributes(this.image,this.canvas,{except:["src"]}),this.image.parentNode.replaceChild(this.canvas,this.image),this.imageAdjustments(),this.waitForImageLoaded()},i.prototype.initCanvas=function(){return this.canvas=this.initObj,this.context=this.canvas.getContext("2d"),null!=this.imageUrl?(this.image=document.createElement("img"),this.image.src=this.imageUrl,this.imageAdjustments(),this.waitForImageLoaded()):this.finishInit()},i.prototype.imageAdjustments=function(){if(this.needsHiDPISwap()&&(f.debug(this.image.src,"->",this.hiDPIReplacement()),this.swapped=!0,this.image.src=this.hiDPIReplacement()),l.isRemote(this.image))return this.image.src=l.proxyUrl(this.image.src),f.debug("Remote image detected, using URL = "+this.image.src)},i.prototype.waitForImageLoaded=function(){return this.isImageLoaded()?this.imageLoaded():this.image.onload=this.imageLoaded},i.prototype.isImageLoaded=function(){return!!this.image.complete&&(null==this.image.naturalWidth||0!==this.image.naturalWidth)},i.prototype.imageWidth=function(){return this.image.width||this.image.naturalWidth},i.prototype.imageHeight=function(){return this.image.height||this.image.naturalHeight},i.prototype.imageLoaded=function(){return f.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.swapped?(this.canvas.width=this.imageWidth()/this.hiDPIRatio(),this.canvas.height=this.imageHeight()/this.hiDPIRatio()):(this.canvas.width=this.imageWidth(),this.canvas.height=this.imageHeight()),this.finishInit()},i.prototype.finishInit=function(){var t,e,n,r,o;if(null==this.context&&(this.context=this.canvas.getContext("2d")),this.originalWidth=this.preScaledWidth=this.width=this.canvas.width,this.originalHeight=this.preScaledHeight=this.height=this.canvas.height,this.hiDPIAdjustments(),this.hasId()||this.assignId(),null!=this.image&&this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight),this.reloadCanvasData(),i.allowRevert)for(this.initializedPixelData=x.dataArray(this.pixelData.length),this.originalPixelData=x.dataArray(this.pixelData.length),t=n=0,r=(o=this.pixelData).length;n<r;t=++n)this.initializedPixelData[t]=e=o[t],this.originalPixelData[t]=e;return this.dimensions={width:this.canvas.width,height:this.canvas.height},v.put(this.id,this),this.callback.call(this,this),this.callback=function(){}},i.prototype.reloadCanvasData=function(){return this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data},i.prototype.resetOriginalPixelData=function(){var t,e,n,r;if(!i.allowRevert)throw"Revert disabled";for(this.originalPixelData=x.dataArray(this.pixelData.length),r=[],t=0,e=(n=this.pixelData).length;t<e;t++)r.push(this.originalPixelData.push(n[t]));return r},i.prototype.hasId=function(){return null!=i.getAttrId(this.canvas)},i.prototype.assignId=function(){if(!i.NodeJS&&!this.canvas.getAttribute("data-caman-id"))return this.canvas.setAttribute("data-caman-id",this.id)},i.prototype.hiDPIDisabled=function(){return null!==this.canvas.getAttribute("data-caman-hidpi-disabled")},i.prototype.hiDPIAdjustments=function(){var t;if(!i.NodeJS&&!this.hiDPIDisabled())return 1!==(t=this.hiDPIRatio())?(f.debug("HiDPI ratio = "+t),this.scaled=!0,this.preScaledWidth=this.canvas.width,this.preScaledHeight=this.canvas.height,this.canvas.width=this.preScaledWidth*t,this.canvas.height=this.preScaledHeight*t,this.canvas.style.width=this.preScaledWidth+"px",this.canvas.style.height=this.preScaledHeight+"px",this.context.scale(t,t),this.width=this.originalWidth=this.canvas.width,this.height=this.originalHeight=this.canvas.height):void 0},i.prototype.hiDPIRatio=function(){return(window.devicePixelRatio||1)/(this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1)},i.prototype.hiDPICapable=function(){return null!=window.devicePixelRatio&&1!==window.devicePixelRatio},i.prototype.needsHiDPISwap=function(){return!(this.hiDPIDisabled()||!this.hiDPICapable())&&null!==this.hiDPIReplacement()},i.prototype.hiDPIReplacement=function(){return null==this.image?null:this.image.getAttribute("data-caman-hidpi")},i.prototype.replaceCanvas=function(t){var e;return e=this.canvas,this.canvas=t,this.context=this.canvas.getContext("2d"),e.parentNode.replaceChild(this.canvas,e),this.width=this.canvas.width,this.height=this.canvas.height,this.reloadCanvasData(),this.dimensions={width:this.canvas.width,height:this.canvas.height}},i.prototype.render=function(t){var e=this;return null==t&&(t=function(){}),h.trigger(this,"renderStart"),this.renderer.execute(function(){return e.context.putImageData(e.imageData,0,0),t.call(e)})},i.prototype.revert=function(){var t,e,n,r;if(!i.allowRevert)throw"Revert disabled";for(t=e=0,n=(r=this.originalVisiblePixels()).length;e<n;t=++e)this.pixelData[t]=r[t];return this.context.putImageData(this.imageData,0,0)},i.prototype.reset=function(){var t,e,i,n,r,o,s,a;for(t=document.createElement("canvas"),x.copyAttributes(this.canvas,t),t.width=this.originalWidth,t.height=this.originalHeight,r=(n=(e=t.getContext("2d")).getImageData(0,0,t.width,t.height)).data,i=o=0,s=(a=this.initializedPixelData).length;o<s;i=++o)r[i]=a[i];return e.putImageData(n,0,0),this.cropCoordinates={x:0,y:0},this.resized=!1,this.replaceCanvas(t)},i.prototype.originalVisiblePixels=function(){var t,e,n,r,o,s,a,h,c,u,l,d,g,f,m,y,b,v,x,w;if(!i.allowRevert)throw"Revert disabled";if(c=[],r=(l=this.cropCoordinates.x)+this.width,o=(d=this.cropCoordinates.y)+this.height,this.resized){for((t=document.createElement("canvas")).width=this.originalWidth,t.height=this.originalHeight,h=(a=(n=t.getContext("2d")).getImageData(0,0,t.width,t.height)).data,s=f=0,y=(b=this.originalPixelData).length;f<y;s=++f)h[s]=b[s];n.putImageData(a,0,0),(u=document.createElement("canvas")).width=this.width,u.height=this.height,(n=u.getContext("2d")).drawImage(t,0,0,this.originalWidth,this.originalHeight,0,0,this.width,this.height),h=n.getImageData(0,0,this.width,this.height).data,g=this.width}else h=this.originalPixelData,g=this.originalWidth;for(s=m=0,v=h.length;m<v;s=m+=4)l<=(x=(e=p.locationToCoordinates(s,g)).x)&&x<r&&d<=(w=e.y)&&w<o&&c.push(h[s],h[s+1],h[s+2],h[s+3]);return c},i.prototype.process=function(t,e){return this.renderer.add({type:u.Type.Single,name:t,processFn:e}),this},i.prototype.processKernel=function(t,e,i,n){var r,o,s;if(!i)for(i=0,r=o=0,s=e.length;0<=s?o<s:o>s;r=0<=s?++o:--o)i+=e[r];return this.renderer.add({type:u.Type.Kernel,name:t,adjust:e,divisor:i,bias:n||0}),this},i.prototype.processPlugin=function(t,e){return this.renderer.add({type:u.Type.Plugin,plugin:t,args:e}),this},i.prototype.newLayer=function(t){var e;return e=new g(this),this.canvasQueue.push(e),this.renderer.add({type:u.Type.LayerDequeue}),t.call(e),this.renderer.add({type:u.Type.LayerFinished}),this},i.prototype.executeLayer=function(t){return this.pushContext(t)},i.prototype.pushContext=function(t){return this.layerStack.push(this.currentLayer),this.pixelStack.push(this.pixelData),this.currentLayer=t,this.pixelData=t.pixelData},i.prototype.popContext=function(){return this.pixelData=this.pixelStack.pop(),this.currentLayer=this.layerStack.pop()},i.prototype.applyCurrentLayer=function(){return this.currentLayer.applyToParent()},i}(),e=function(){function t(t){this.c=t}return t.prototype.calculateLevels=function(){var t,e,i,n,r,o,s;for(e={r:{},g:{},b:{}},t=n=0;n<=255;t=++n)e.r[t]=0,e.g[t]=0,e.b[t]=0;for(t=r=0,s=this.c.pixelData.length;r<s;t=r+=4)e.r[this.c.pixelData[t]]++,e.g[this.c.pixelData[t+1]]++,e.b[this.c.pixelData[t+2]]++;for(i=this.c.pixelData.length/4,t=o=0;o<=255;t=++o)e.r[t]/=i,e.g[t]/=i,e.b[t]/=i;return e},t}(),r.DOMUpdated=function(){var t,e,i,n;if((t=document.querySelectorAll("img[data-caman]")).length>0){for(n=[],e=0,i=t.length;e<i;e++)n.push(new o(t[e],function(){return this.parse(),this.execute()}));return n}},r.autoload&&("complete"===document.readyState?r.DOMUpdated():document.addEventListener("DOMContentLoaded",r.DOMUpdated,!1)),o=function(){function t(t,e){this.dataStr=t.getAttribute("data-caman"),this.caman=r(t,e.bind(this))}return t.prototype.parse=function(){var t,e,i,n,r,o,s,a;if(this.ele=this.caman.canvas,i=new RegExp("(\\w+)\\((.*?)\\)","g"),(n=this.dataStr.match(i)).length>0){for(i=new RegExp("(\\w+)\\((.*?)\\)"),a=[],r=0,o=n.length;r<o;r++){s=n[r].match(i),e=new Function("return function() {        this."+s[1]+"("+s[2]+");      };");try{t=e(),a.push(t.call(this.caman))}catch(h){a.push(f.debug(h))}}return a}},t.prototype.execute=function(){var t;return t=this.ele,this.caman.render(function(){return t.parentNode.replaceChild(this.toImage(),t)})},t}(),r.Blender=i=function(){function t(){}return t.blenders={},t.register=function(t,e){return this.blenders[t]=e},t.execute=function(t,e,i){return this.blenders[t](e,i)},t}(),r.Calculate=n=function(){function t(){}return t.distance=function(t,e,i,n){return Math.sqrt(Math.pow(i-t,2)+Math.pow(n-e,2))},t.randomRange=function(t,e,i){var n;return null==i&&(i=!1),n=t+Math.random()*(e-t),i?n.toFixed(i):Math.round(n)},t.luminance=function(t){return.299*t.r+.587*t.g+.114*t.b},t.bezier=function(t,e,i,n,r,o){var s,a,h,c,u,l,d,g,f,p,m,y,b,v,x,w,D,M,P,R,S,I,B,L,C,k;for(M=t[1],w=e[0],P=e[1],D=i[0],R=i[1],S=n[1],d={},s=n[0]-(x=t[0])-(u=parseInt(3*(w-x),10))-(h=3*(D-w)-u),a=S-M-(l=3*(P-M))-(c=3*(R-P)-l),p=I=0;I<1e3;p=++I)v=p/1e3,g=Math.round(s*Math.pow(v,3)+h*Math.pow(v,2)+u*v+x),f=Math.round(a*Math.pow(v,3)+c*Math.pow(v,2)+l*v+M),r&&f<r?f=r:o&&f>o&&(f=o),d[g]=f;if(d.length<n[0]+1)for(p=B=0,C=n[0];0<=C?B<=C:B>=C;p=0<=C?++B:--B)if(null==d[p]){for(y=[p-1,d[p-1]],m=L=p,k=n[0];p<=k?L<=k:L>=k;m=p<=k?++L:--L)if(null!=d[m]){b=[m,d[m]];break}d[p]=y[1]+(b[1]-y[1])/(b[0]-y[0])*(p-y[0])}return null==d[n[0]]&&(d[n[0]]=d[n[0]-1]),d},t}(),a=function(){function t(){}return t.hexToRGB=function(t){return"#"===t.charAt(0)&&(t=t.substr(1)),{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16)}},t.rgbToHSL=function(t,e,i){var n,r,o,s,a,h;return"object"==typeof t&&(e=t.g,i=t.b,t=t.r),t/=255,e/=255,i/=255,s=Math.max(t,e,i),a=Math.min(t,e,i),o=(s+a)/2,s===a?r=h=0:(n=s-a,h=o>.5?n/(2-s-a):n/(s+a),r=function(){switch(s){case t:return(e-i)/n+(e<i?6:0);case e:return(i-t)/n+2;case i:return(t-e)/n+4}}(),r/=6),{h:r,s:h,l:o}},t.hslToRGB=function(t,e,i){var n,r,o,s,a;return"object"==typeof t&&(e=t.s,i=t.l,t=t.h),0===e?a=r=n=i:(a=this.hueToRGB(o=2*i-(s=i<.5?i*(1+e):i+e-i*e),s,t+1/3),r=this.hueToRGB(o,s,t),n=this.hueToRGB(o,s,t-1/3)),{r:255*a,g:255*r,b:255*n}},t.hueToRGB=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},t.rgbToHSV=function(t,e,i){var n,r,o,s,a,h;return t/=255,e/=255,i/=255,o=Math.max(t,e,i),s=Math.min(t,e,i),h=o,n=o-s,a=0===o?0:n/o,o===s?r=0:(r=function(){switch(o){case t:return(e-i)/n+(e<i?6:0);case e:return(i-t)/n+2;case i:return(t-e)/n+4}}(),r/=6),{h:r,s:a,v:h}},t.hsvToRGB=function(t,e,i){var n,r,o,s,a,h,c,u;switch(a=i*(1-e),h=i*(1-(r=6*t-(s=Math.floor(6*t)))*e),u=i*(1-(1-r)*e),s%6){case 0:c=i,o=u,n=a;break;case 1:c=h,o=i,n=a;break;case 2:c=a,o=i,n=u;break;case 3:c=a,o=h,n=i;break;case 4:c=u,o=a,n=i;break;case 5:c=i,o=a,n=h}return{r:255*c,g:255*o,b:255*n}},t.rgbToXYZ=function(t,e,i){return e/=255,i/=255,(t/=255)>.04045?t=Math.pow((t+.055)/1.055,2.4):t/=12.92,e>.04045?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,i>.04045?i=Math.pow((i+.055)/1.055,2.4):i/=12.92,{x:100*(.4124*t+.3576*e+.1805*i),y:100*(.2126*t+.7152*e+.0722*i),z:100*(.0193*t+.1192*e+.9505*i)}},t.xyzToRGB=function(t,e,i){var n,r,o;return r=-.9689*(t/=100)+1.8758*(e/=100)+.0415*(i/=100),n=.0557*t+-.204*e+1.057*i,(o=3.2406*t+-1.5372*e+-.4986*i)>.0031308?o=1.055*Math.pow(o,.4166666667)-.055:o*=12.92,r>.0031308?r=1.055*Math.pow(r,.4166666667)-.055:r*=12.92,n>.0031308?n=1.055*Math.pow(n,.4166666667)-.055:n*=12.92,{r:255*o,g:255*r,b:255*n}},t.xyzToLab=function(t,e,i){return"object"==typeof t&&(e=t.y,i=t.z,t=t.x),e/=100,i/=108.883,t=(t/=95.047)>.008856451679?Math.pow(t,.3333333333):7.787037037*t+.1379310345,{l:116*(e=e>.008856451679?Math.pow(e,.3333333333):7.787037037*e+.1379310345)-16,a:500*(t-e),b:200*(e-(i=i>.008856451679?Math.pow(i,.3333333333):7.787037037*i+.1379310345))}},t.labToXYZ=function(t,e,i){var n,r,o;return"object"==typeof t&&(e=t.a,i=t.b,t=t.l),o=(r=(t+16)/116)-i/200,(n=r+e/500)>.2068965517?n*=n*n:n=.1284185493*(n-.1379310345),r>.2068965517?r*=r*r:r=.1284185493*(r-.1379310345),o>.2068965517?o*=o*o:o=.1284185493*(o-.1379310345),{x:95.047*n,y:100*r,z:108.883*o}},t.rgbToLab=function(t,e,i){var n;return"object"==typeof t&&(e=t.g,i=t.b,t=t.r),n=this.rgbToXYZ(t,e,i),this.xyzToLab(n)},t.labToRGB=function(t,e,i){},t}(),h=function(){function t(){}return t.events={},t.types=["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"],t.trigger=function(t,e,i){var n,r,o,s,a;if(this.events[e]&&this.events[e].length){for(a=[],r=0,o=(s=this.events[e]).length;r<o;r++)a.push(null===(n=s[r]).target||t.id===n.target.id?n.fn.call(t,i):void 0);return a}},t.listen=function(t,e,i){var n,r;return"string"==typeof t&&(r=t,n=e,t=null,e=r,i=n),!(C.call(this.types,e)<0||(this.events[e]||(this.events[e]=[]),this.events[e].push({target:t,fn:i}),0))},t}(),r.Event=h,r.Filter=u=function(){function t(){}return t.Type={Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6},t.register=function(t,e){return r.prototype[t]=e},t}(),r.IO=l=function(){function t(){}return t.domainRegex=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/,t.isRemote=function(t){return null!=t&&!this.corsEnabled(t)&&this.isURLRemote(t.src)},t.corsEnabled=function(t){var e;return null!=t.crossOrigin&&("anonymous"===(e=t.crossOrigin.toLowerCase())||"use-credentials"===e)},t.isURLRemote=function(t){var e;return!!(e=t.match(this.domainRegex))&&e[1]!==document.domain},t.remoteCheck=function(t){if(this.isURLRemote(t)){if(r.remoteProxy.length)return r.isURLRemote(r.remoteProxy)?void f.info("Cannot use a remote proxy for loading images."):r.remoteProxy+"?camanProxyUrl="+encodeURIComponent(t);f.info("Attempting to load a remote image without a configured proxy. URL: "+t)}},t.proxyUrl=function(t){return r.remoteProxy+"?"+r.proxyParam+"="+encodeURIComponent(t)},t.useProxy=function(t){var e;return null!=(e={ruby:"rb",python:"py",perl:"pl",javascript:"js"})[t=t.toLowerCase()]&&(t=e[t]),"proxies/caman_proxy."+t},t}(),r.prototype.save=function(){return"undefined"!=typeof exports&&null!==exports?this.nodeSave.apply(this,arguments):this.browserSave.apply(this,arguments)},r.prototype.browserSave=function(t){var e;return null==t&&(t="png"),t=t.toLowerCase(),e=this.toBase64(t).replace("image/"+t,"image/octet-stream"),document.location.href=e},r.prototype.nodeSave=function(t,e){null==e&&(e=!0);try{if(w.statSync(t).isFile()&&!e)return!1}catch(i){f.debug("Creating output file "+t)}return w.writeFile(t,this.canvas.toBuffer(),function(){return f.debug("Finished writing to "+t)})},r.prototype.toImage=function(t){var e;return(e=document.createElement("img")).src=this.toBase64(t),e.width=this.dimensions.width,e.height=this.dimensions.height,window.devicePixelRatio&&(e.width/=window.devicePixelRatio,e.height/=window.devicePixelRatio),e},r.prototype.toBase64=function(t){return null==t&&(t="png"),t=t.toLowerCase(),this.canvas.toDataURL("image/"+t)},g=function(){function e(t){this.c=t,this.filter=this.c,this.options={blendingMode:"normal",opacity:1},this.layerID=x.uniqid.get(),this.canvas="undefined"!=typeof exports&&null!==exports?new s:document.createElement("canvas"),this.canvas.width=this.c.dimensions.width,this.canvas.height=this.c.dimensions.height,this.context=this.canvas.getContext("2d"),this.context.createImageData(this.canvas.width,this.canvas.height),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data}return e.prototype.newLayer=function(t){return this.c.newLayer.call(this.c,t)},e.prototype.setBlendingMode=function(t){return this.options.blendingMode=t,this},e.prototype.opacity=function(t){return this.options.opacity=t/100,this},e.prototype.copyParent=function(){var t,e,i,n;for(e=this.c.pixelData,t=i=0,n=this.c.pixelData.length;i<n;t=i+=4)this.pixelData[t]=e[t],this.pixelData[t+1]=e[t+1],this.pixelData[t+2]=e[t+2],this.pixelData[t+3]=e[t+3];return this},e.prototype.fillColor=function(){return this.c.fillColor.apply(this.c,arguments)},e.prototype.overlayImage=function(e){return"object"==typeof e?e=e.src:"string"==typeof e&&"#"===e[0]&&(e=t(e).src),e?(this.c.renderer.renderQueue.push({type:u.Type.LoadOverlay,src:e,layer:this}),this):this},e.prototype.applyToParent=function(){var t,e,n,r,o,s,a,h,c;for(n=this.c.pixelStack[this.c.pixelStack.length-1],c=[],t=a=0,h=(e=this.c.pixelData).length;a<h;t=a+=4)(r=i.execute(this.options.blendingMode,o={r:e[t],g:e[t+1],b:e[t+2],a:e[t+3]},s={r:n[t],g:n[t+1],b:n[t+2],a:n[t+3]})).r=x.clampRGB(r.r),r.g=x.clampRGB(r.g),r.b=x.clampRGB(r.b),null==r.a&&(r.a=o.a),n[t]=s.r-this.options.opacity*(r.a/255)*(s.r-r.r),n[t+1]=s.g-this.options.opacity*(r.a/255)*(s.g-r.g),c.push(n[t+2]=s.b-this.options.opacity*(r.a/255)*(s.b-r.b));return c},e}(),f=new function(){var t,e,i,n;for(e=0,i=(n=["log","info","warn","error"]).length;e<i;e++)this[t=n[e]]=function(t){return function(){var e;if(e=1<=arguments.length?k.call(arguments,0):[],r.DEBUG)try{return console[t].apply(console,e)}catch(i){return console[t](e)}}}(t);this.debug=this.log},p=function(){function t(t){this.c=t,this.loc=0}return t.coordinatesToLocation=function(t,e,i){return 4*(e*i+t)},t.locationToCoordinates=function(t,e){return{x:t%(4*e)/4,y:Math.floor(t/(4*e))}},t.prototype.locationXY=function(){var t;return t=this.c.dimensions.height-Math.floor(this.loc/(4*this.c.dimensions.width)),{x:this.loc%(4*this.c.dimensions.width)/4,y:t}},t.prototype.getPixelRelative=function(t,e){var i;return(i=this.loc+4*this.c.dimensions.width*(-1*e)+4*t)>this.c.pixelData.length||i<0?{r:0,g:0,b:0,a:0}:{r:this.c.pixelData[i],g:this.c.pixelData[i+1],b:this.c.pixelData[i+2],a:this.c.pixelData[i+3]}},t.prototype.putPixelRelative=function(t,e,i){if(!(newLoc>this.c.pixelData.length||newLoc<0))return this.c.pixelData[newLoc]=i.r,this.c.pixelData[newLoc+1]=i.g,this.c.pixelData[newLoc+2]=i.b,this.c.pixelData[newLoc+3]=i.a,!0},t.prototype.getPixel=function(t,e){var i;return i=this.coordinatesToLocation(t,e,this.width),{r:this.c.pixelData[i],g:this.c.pixelData[i+1],b:this.c.pixelData[i+2],a:this.c.pixelData[i+3]}},t.prototype.putPixel=function(t,e,i){var n;return n=this.coordinatesToLocation(t,e,this.width),this.c.pixelData[n]=i.r,this.c.pixelData[n+1]=i.g,this.c.pixelData[n+2]=i.b,this.c.pixelData[n+3]=i.a},t}(),m=function(){function t(){}return t.plugins={},t.register=function(t,e){return this.plugins[t]=e},t.execute=function(t,e,i){return this.plugins[e].apply(t,i)},t}(),r.Plugin=m,r.Renderer=y=function(){function t(e){var i=this;this.c=e,this.processNext=function(){return t.prototype.processNext.apply(i,arguments)},this.renderQueue=[],this.modPixelData=null}return t.Blocks=r.NodeJS?require("os").cpus().length:4,t.prototype.add=function(t){if(null!=t)return this.renderQueue.push(t)},t.prototype.processNext=function(){var t;if(0===this.renderQueue.length)return h.trigger(this,"renderFinished"),null!=this.finishedFn&&this.finishedFn.call(this.c),this;switch(this.currentJob=this.renderQueue.shift(),this.currentJob.type){case u.Type.LayerDequeue:return t=this.c.canvasQueue.shift(),this.c.executeLayer(t),this.processNext();case u.Type.LayerFinished:return this.c.applyCurrentLayer(),this.c.popContext(),this.processNext();case u.Type.LoadOverlay:return this.loadOverlay(this.currentJob.layer,this.currentJob.src);case u.Type.Plugin:return this.executePlugin();default:return this.executeFilter()}},t.prototype.execute=function(t){return this.finishedFn=t,this.modPixelData=x.dataArray(this.c.pixelData.length),this.processNext()},t.prototype.eachBlock=function(e){var i,n,o,s,a,h,u,l,d,g,f=this;for(this.blocksDone=0,h=this.c.pixelData.length,a=(i=4*Math.floor(h/4/t.Blocks))+h/4%t.Blocks*4,g=[],s=l=0,d=t.Blocks;0<=d?l<d:l>d;s=0<=d?++l:--l)o=(u=s*i)+(s===t.Blocks-1?a:i),r.NodeJS?(n=c(function(){return e.call(f,s,u,o)}).run(),g.push(this.blockFinished(n))):g.push(setTimeout(function(t,i,n){return function(){return e.call(f,t,i,n)}}(s,u,o),0));return g},t.prototype.executeFilter=function(){return h.trigger(this.c,"processStart",this.currentJob),this.eachBlock(this.currentJob.type===u.Type.Single?this.renderBlock:this.renderKernel)},t.prototype.executePlugin=function(){return f.debug("Executing plugin "+this.currentJob.plugin),m.execute(this.c,this.currentJob.plugin,this.currentJob.args),f.debug("Plugin "+this.currentJob.plugin+" finished!"),this.processNext()},t.prototype.renderBlock=function(e,i,n){var o,s,a,u,l;for(f.debug("Block #"+e+" - Filter: "+this.currentJob.name+", Start: "+i+", End: "+n),h.trigger(this.c,"blockStarted",{blockNum:e,totalBlocks:t.Blocks,startPixel:i,endPixel:n}),o={r:0,g:0,b:0,a:0},a=new p(this.c),s=l=i;l<n;s=l+=4)a.loc=s,o.r=this.c.pixelData[s],o.g=this.c.pixelData[s+1],o.b=this.c.pixelData[s+2],o.a=this.c.pixelData[s+3],null==(u=this.currentJob.processFn.call(a,o)).a&&(u.a=o.a),this.c.pixelData[s]=x.clampRGB(u.r),this.c.pixelData[s+1]=x.clampRGB(u.g),this.c.pixelData[s+2]=x.clampRGB(u.b),this.c.pixelData[s+3]=x.clampRGB(u.a);return r.NodeJS?c.yield(e):this.blockFinished(e)},t.prototype.renderKernel=function(t,e,i){var n,o,s,a,h,u,l,d,g,m,y,b,v,w,D,M,P;for(s=this.currentJob.bias,u=this.currentJob.divisor,y=this.c.pixelData.length,n=this.currentJob.adjust,o=Math.sqrt(n.length),m=[],f.debug("Rendering kernel - Filter: "+this.currentJob.name),e=Math.max(e,4*this.c.dimensions.width*((o-1)/2)),i=Math.min(i,y-4*this.c.dimensions.width*((o-1)/2)),a=(o-1)/2,v=new p(this.c),l=D=e;D<i;l=D+=4){for(v.loc=l,h=0,d=M=-a;-a<=a?M<=a:M>=a;d=-a<=a?++M:--M)for(g=P=a;a<=-a?P<=-a:P>=-a;g=a<=-a?++P:--P)b=v.getPixelRelative(d,g),m[3*h]=b.r,m[3*h+1]=b.g,m[3*h+2]=b.b,h++;w=this.processKernel(n,m,u,s),this.modPixelData[l]=x.clampRGB(w.r),this.modPixelData[l+1]=x.clampRGB(w.g),this.modPixelData[l+2]=x.clampRGB(w.b),this.modPixelData[l+3]=this.c.pixelData[l+3]}return r.NodeJS?c.yield(t):this.blockFinished(t)},t.prototype.blockFinished=function(e){var i,n,r;if(e>=0&&f.debug("Block #"+e+" finished! Filter: "+this.currentJob.name),this.blocksDone++,h.trigger(this.c,"blockFinished",{blockNum:e,blocksFinished:this.blocksDone,totalBlocks:t.Blocks}),this.blocksDone===t.Blocks){if(this.currentJob.type===u.Type.Kernel)for(i=n=0,r=this.c.pixelData.length;0<=r?n<r:n>r;i=0<=r?++n:--n)this.c.pixelData[i]=this.modPixelData[i];return e>=0&&f.debug("Filter "+this.currentJob.name+" finished!"),h.trigger(this.c,"processComplete",this.currentJob),this.processNext()}},t.prototype.processKernel=function(t,e,i,n){var r,o,s,a;for(o={r:0,g:0,b:0},r=s=0,a=t.length;0<=a?s<a:s>a;r=0<=a?++s:--s)o.r+=t[r]*e[3*r],o.g+=t[r]*e[3*r+1],o.b+=t[r]*e[3*r+2];return o.r=o.r/i+n,o.g=o.g/i+n,o.b=o.b/i+n,o},t.prototype.loadOverlay=function(t,e){var i,n,r=this;return(i=document.createElement("img")).onload=function(){return t.context.drawImage(i,0,0,r.c.dimensions.width,r.c.dimensions.height),t.imageData=t.context.getImageData(0,0,r.c.dimensions.width,r.c.dimensions.height),t.pixelData=t.imageData.data,r.c.pixelData=t.pixelData,r.processNext()},n=l.remoteCheck(e),i.src=null!=n?n:e},t}(),r.Store=v=function(){function t(){}return t.items={},t.has=function(t){return null!=this.items[t]},t.get=function(t){return this.items[t]},t.put=function(t,e){return this.items[t]=e},t.execute=function(t,e){var i=this;return setTimeout(function(){return e.call(i.get(t),i.get(t))},0),this.get(t)},t.flush=function(t){return null==t&&(t=!1),t?delete this.items[t]:this.items={}},t}(),i.register("normal",function(t,e){return{r:t.r,g:t.g,b:t.b}}),i.register("multiply",function(t,e){return{r:t.r*e.r/255,g:t.g*e.g/255,b:t.b*e.b/255}}),i.register("screen",function(t,e){return{r:255-(255-t.r)*(255-e.r)/255,g:255-(255-t.g)*(255-e.g)/255,b:255-(255-t.b)*(255-e.b)/255}}),i.register("overlay",function(t,e){var i;return(i={}).r=e.r>128?255-2*(255-t.r)*(255-e.r)/255:e.r*t.r*2/255,i.g=e.g>128?255-2*(255-t.g)*(255-e.g)/255:e.g*t.g*2/255,i.b=e.b>128?255-2*(255-t.b)*(255-e.b)/255:e.b*t.b*2/255,i}),i.register("difference",function(t,e){return{r:t.r-e.r,g:t.g-e.g,b:t.b-e.b}}),i.register("addition",function(t,e){return{r:e.r+t.r,g:e.g+t.g,b:e.b+t.b}}),i.register("exclusion",function(t,e){return{r:128-2*(e.r-128)*(t.r-128)/255,g:128-2*(e.g-128)*(t.g-128)/255,b:128-2*(e.b-128)*(t.b-128)/255}}),i.register("softLight",function(t,e){var i;return(i={}).r=e.r>128?255-(255-e.r)*(255-(t.r-128))/255:e.r*(t.r+128)/255,i.g=e.g>128?255-(255-e.g)*(255-(t.g-128))/255:e.g*(t.g+128)/255,i.b=e.b>128?255-(255-e.b)*(255-(t.b-128))/255:e.b*(t.b+128)/255,i}),i.register("lighten",function(t,e){return{r:e.r>t.r?e.r:t.r,g:e.g>t.g?e.g:t.g,b:e.b>t.b?e.b:t.b}}),i.register("darken",function(t,e){return{r:e.r>t.r?t.r:e.r,g:e.g>t.g?t.g:e.g,b:e.b>t.b?t.b:e.b}}),u.register("fillColor",function(){var t;return t=1===arguments.length?a.hexToRGB(arguments[0]):{r:arguments[0],g:arguments[1],b:arguments[2]},this.process("fillColor",function(e){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=255,e})}),u.register("brightness",function(t){return t=Math.floor(t/100*255),this.process("brightness",function(e){return e.r+=t,e.g+=t,e.b+=t,e})}),u.register("saturation",function(t){return t*=-.01,this.process("saturation",function(e){var i;return i=Math.max(e.r,e.g,e.b),e.r!==i&&(e.r+=(i-e.r)*t),e.g!==i&&(e.g+=(i-e.g)*t),e.b!==i&&(e.b+=(i-e.b)*t),e})}),u.register("vibrance",function(t){return t*=-1,this.process("vibrance",function(e){var i,n;return n=Math.max(e.r,e.g,e.b),i=2*Math.abs(n-(e.r+e.g+e.b)/3)/255*t/100,e.r!==n&&(e.r+=(n-e.r)*i),e.g!==n&&(e.g+=(n-e.g)*i),e.b!==n&&(e.b+=(n-e.b)*i),e})}),u.register("greyscale",function(t){return this.process("greyscale",function(t){var e;return e=n.luminance(t),t.r=e,t.g=e,t.b=e,t})}),u.register("contrast",function(t){return t=Math.pow((t+100)/100,2),this.process("contrast",function(e){return e.r/=255,e.r-=.5,e.r*=t,e.r+=.5,e.r*=255,e.g/=255,e.g-=.5,e.g*=t,e.g+=.5,e.g*=255,e.b/=255,e.b-=.5,e.b*=t,e.b+=.5,e.b*=255,e})}),u.register("hue",function(t){return this.process("hue",function(e){var i,n,r;return i=100*(n=a.rgbToHSV(e.r,e.g,e.b)).h,i+=Math.abs(t),i%=100,n.h=i/=100,(r=a.hsvToRGB(n.h,n.s,n.v)).a=e.a,r})}),u.register("colorize",function(){var t,e;return 2===arguments.length?(e=a.hexToRGB(arguments[0]),t=arguments[1]):4===arguments.length&&(e={r:arguments[0],g:arguments[1],b:arguments[2]},t=arguments[3]),this.process("colorize",function(i){return i.r-=t/100*(i.r-e.r),i.g-=t/100*(i.g-e.g),i.b-=t/100*(i.b-e.b),i})}),u.register("invert",function(){return this.process("invert",function(t){return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,t})}),u.register("sepia",function(t){return null==t&&(t=100),t/=100,this.process("sepia",function(e){return e.r=Math.min(255,e.r*(1-.607*t)+e.g*(.769*t)+e.b*(.189*t)),e.g=Math.min(255,e.r*(.349*t)+e.g*(1-.314*t)+e.b*(.168*t)),e.b=Math.min(255,e.r*(.272*t)+e.g*(.534*t)+e.b*(1-.869*t)),e})}),u.register("gamma",function(t){return this.process("gamma",function(e){return e.r=255*Math.pow(e.r/255,t),e.g=255*Math.pow(e.g/255,t),e.b=255*Math.pow(e.b/255,t),e})}),u.register("noise",function(t){return t=2.55*Math.abs(t),this.process("noise",function(e){var i;return i=n.randomRange(-1*t,t),e.r+=i,e.g+=i,e.b+=i,e})}),u.register("clip",function(t){return t=2.55*Math.abs(t),this.process("clip",function(e){return e.r>255-t?e.r=255:e.r<t&&(e.r=0),e.g>255-t?e.g=255:e.g<t&&(e.g=0),e.b>255-t?e.b=255:e.b<t&&(e.b=0),e})}),u.register("channels",function(t){var e;if("object"!=typeof t)return this;for(e in t)L.call(t,e)&&(0!==t[e]?t[e]/=100:delete t[e]);return 0===t.length?this:this.process("channels",function(e){return null!=t.red&&(t.red>0?e.r+=(255-e.r)*t.red:e.r-=e.r*Math.abs(t.red)),null!=t.green&&(t.green>0?e.g+=(255-e.g)*t.green:e.g-=e.g*Math.abs(t.green)),null!=t.blue&&(t.blue>0?e.b+=(255-e.b)*t.blue:e.b-=e.b*Math.abs(t.blue)),e})}),u.register("curves",function(){var t,e,i,r,o,s,a,h,c,u;if(e=arguments[0],i=2<=arguments.length?k.call(arguments,1):[],"string"==typeof e&&(e=e.split("")),"v"===e[0]&&(e=["r","g","b"]),i.length<3||i.length>4)throw"Invalid number of arguments to curves filter";if(t=n.bezier(s=i[0],i[1],4===i.length?i[2]:i[1],r=i[i.length-1],0,255),s[0]>0)for(o=a=0,c=s[0];0<=c?a<c:a>c;o=0<=c?++a:--a)t[o]=s[1];if(r[0]<255)for(o=h=u=r[0];u<=255?h<=255:h>=255;o=u<=255?++h:--h)t[o]=r[1];return this.process("curves",function(i){var n,r;for(o=n=0,r=e.length;0<=r?n<r:n>r;o=0<=r?++n:--n)i[e[o]]=t[i[e[o]]];return i})}),u.register("exposure",function(t){var e,i,n;return e=[0,255*(n=Math.abs(t)/100)],i=[255-255*n,255],t<0&&(e=e.reverse(),i=i.reverse()),this.curves("rgb",[0,0],e,i,[255,255])}),r.Plugin.register("crop",function(t,e,i,n){var r;return null==i&&(i=0),null==n&&(n=0),"undefined"!=typeof exports&&null!==exports?r=new s(t,e):(r=document.createElement("canvas"),x.copyAttributes(this.canvas,r),r.width=t,r.height=e),r.getContext("2d").drawImage(this.canvas,i,n,t,e,0,0,t,e),this.cropCoordinates={x:i,y:n},this.cropped=!0,this.replaceCanvas(r)}),r.Plugin.register("resize",function(t){var e;if(null==t&&(t=null),null!==t&&(null!=t.width||null!=t.height))return null==t.width?t.width=this.canvas.width*t.height/this.canvas.height:null==t.height&&(t.height=this.canvas.height*t.width/this.canvas.width),"undefined"!=typeof exports&&null!==exports?e=new s(t.width,t.height):(e=document.createElement("canvas"),x.copyAttributes(this.canvas,e),e.width=t.width,e.height=t.height),e.getContext("2d").drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,t.width,t.height),this.resized=!0,this.replaceCanvas(e);f.error("Invalid or missing dimensions given for resize")}),r.Filter.register("crop",function(){return this.processPlugin("crop",Array.prototype.slice.call(arguments,0))}),r.Filter.register("resize",function(){return this.processPlugin("resize",Array.prototype.slice.call(arguments,0))}),r.Filter.register("boxBlur",function(){return this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1])}),r.Filter.register("heavyRadialBlur",function(){return this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0])}),r.Filter.register("gaussianBlur",function(){return this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1])}),r.Filter.register("motionBlur",function(t){return this.processKernel("Motion Blur",0===t||180===t?[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0]:t>0&&t<90||t>180&&t<270?[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]:90===t||270===t?[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0]:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1])}),r.Filter.register("sharpen",function(t){return null==t&&(t=100),this.processKernel("Sharpen",[0,-(t/=100),0,-t,4*t+1,-t,0,-t,0])}),M={brightness:function(t,e,i){return t.r=t.r-t.r*e*i.strength,t.g=t.g-t.g*e*i.strength,t.b=t.b-t.b*e*i.strength,t},gamma:function(t,e,i){return t.r=255*Math.pow(t.r/255,Math.max(10*e*i.strength,1)),t.g=255*Math.pow(t.g/255,Math.max(10*e*i.strength,1)),t.b=255*Math.pow(t.b/255,Math.max(10*e*i.strength,1)),t},colorize:function(t,e,i){return t.r-=(t.r-i.color.r)*e,t.g-=(t.g-i.color.g)*e,t.b-=(t.b-i.color.b)*e,t}},u.register("vignette",function(t,e){var i,r,o,s;return null==e&&(e=60),"string"==typeof t&&"%"===t.substr(-1)&&(t=this.dimensions.height>this.dimensions.width?this.dimensions.width*(parseInt(t.substr(0,t.length-1),10)/100):this.dimensions.height*(parseInt(t.substr(0,t.length-1),10)/100)),e/=100,r=[this.dimensions.width/2,this.dimensions.height/2],s=Math.sqrt(Math.pow(r[0],2)+Math.pow(r[1],2)),o=s-t,i=n.bezier([0,1],[30,30],[70,60],[100,80]),this.process("vignette",function(s){var a,h,c;return c=this.locationXY(),(a=n.distance(c.x,c.y,r[0],r[1]))>o&&(h=Math.max(1,i[Math.round((a-o)/t*100)]/10*e),s.r=255*Math.pow(s.r/255,h),s.g=255*Math.pow(s.g/255,h),s.b=255*Math.pow(s.b/255,h)),s})}),u.register("rectangularVignette",function(t){var e,i,o,s,h,c;if(!(t=x.extend({strength:50,cornerRadius:0,method:"brightness",color:{r:0,g:0,b:0}},t)).size)return this;if("string"==typeof t.size)i=parseInt(t.size,10)/100,t.size={width:this.dimensions.width*i,height:this.dimensions.height*i};else if("object"==typeof t.size)for(s=0,h=(c=["width","height"]).length;s<h;s++)"string"==typeof t.size[e=c[s]]&&(t.size[e]=this.dimensions[e]*(parseInt(t.size[e],10)/100));else"number"===t.size&&(t.size={width:o=t.size,height:o});return"string"==typeof t.cornerRadius&&(t.cornerRadius=t.size.width/2*(parseInt(t.cornerRadius,10)/100)),t.strength/=100,t.size.width=Math.floor(t.size.width),t.size.height=Math.floor(t.size.height),t.image={width:this.dimensions.width,height:this.dimensions.height},"colorize"===t.method&&"string"==typeof t.color&&(t.color=a.hexToRGB(t.color)),t.coords={left:(this.dimensions.width-t.size.width)/2,right:this.dimensions.width-t.coords.left,bottom:(this.dimensions.height-t.size.height)/2,top:this.dimensions.height-t.coords.bottom},t.corners=[{x:t.coords.left+t.cornerRadius,y:t.coords.top-t.cornerRadius},{x:t.coords.right-t.cornerRadius,y:t.coords.top-t.cornerRadius},{x:t.coords.right-t.cornerRadius,y:t.coords.bottom+t.cornerRadius},{x:t.coords.left+t.cornerRadius,y:t.coords.bottom+t.cornerRadius}],t.maxDist=n.distance(0,0,t.corners[3].x,t.corners[3].y)-t.cornerRadius,this.process("rectangularVignette",function(e){var i,n;return(n=this.locationXY()).x>t.corners[0].x&&n.x<t.corners[1].x&&n.y>t.coords.bottom&&n.y<t.coords.top?e:n.x>t.coords.left&&n.x<t.coords.right&&n.y>t.corners[3].y&&n.y<t.corners[2].y?e:(n.x>t.corners[0].x&&n.x<t.corners[1].x&&n.y>t.coords.top?i=(n.y-t.coords.top)/t.maxDist:n.y>t.corners[2].y&&n.y<t.corners[1].y&&n.x>t.coords.right?i=(n.x-t.coords.right)/t.maxDist:n.x>t.corners[0].x&&n.x<t.corners[1].x&&n.y<t.coords.bottom?i=(t.coords.bottom-n.y)/t.maxDist:n.y>t.corners[2].y&&n.y<t.corners[1].y&&n.x<t.coords.left?i=(t.coords.left-n.x)/t.maxDist:n.x<=t.corners[0].x&&n.y>=t.corners[0].y?i=(r.distance(n.x,n.y,t.corners[0].x,t.corners[0].y)-t.cornerRadius)/t.maxDist:n.x>=t.corners[1].x&&n.y>=t.corners[1].y?i=(r.distance(n.x,n.y,t.corners[1].x,t.corners[1].y)-t.cornerRadius)/t.maxDist:n.x>=t.corners[2].x&&n.y<=t.corners[2].y?i=(r.distance(n.x,n.y,t.corners[2].x,t.corners[2].y)-t.cornerRadius)/t.maxDist:n.x<=t.corners[3].x&&n.y<=t.corners[3].y&&(i=(r.distance(n.x,n.y,t.corners[3].x,t.corners[3].y)-t.cornerRadius)/t.maxDist),i<0?e:M[t.method](e,i,t))})}),I=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],B=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],R=function(t,e,i,n,r,o,a){var h,c,u,l,d,g,f;return(h="undefined"!=typeof exports&&null!==exports?new s:document.createElement("canvas")).width=t,h.height=e,l=i+Math.cos(r)*o*.5,g=n+Math.sin(r)*o*.5,d=i-Math.cos(r)*o*.5,f=n-Math.sin(r)*o*.5,u=(c=h.getContext("2d")).createLinearGradient(l,g,d,f),a?(u.addColorStop(0,"white"),u.addColorStop(.5,"black"),u.addColorStop(1,"white")):(u.addColorStop(0,"white"),u.addColorStop(1,"black")),c.fillStyle=u,c.fillRect(0,0,t,e),c.getImageData(0,0,t,e)},S=function(t,e,i,n,r,o){var a,h,c;return(a="undefined"!=typeof exports&&null!==exports?new s:document.createElement("canvas")).width=t,a.height=e,(c=(h=a.getContext("2d")).createRadialGradient(i,n,r,i,n,o)).addColorStop(1,"white"),c.addColorStop(0,"black"),h.fillStyle=c,h.fillRect(0,0,t,e),h.getImageData(0,0,t,e)},P=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},r.Plugin.register("compoundBlur",function(t,e,i,n){var r,o,s,a,h,c,u,l,d,g,f,p,m,y,b,v,x,w,D,M,R,S,L,C,k,F,E,z,T,A,j,N,O,J,q,G,W,H,U,K,Y,X,V,Z,Q,_,$,tt,et,it,nt,rt,ot,st,at,ht,ct;for(b=this.pixelData,z=t.data,K=(U=(Y=this.dimensions.width)*(g=this.dimensions.height))<<2,L=[],p=tt=0;0<=K?tt<K:tt>K;p=0<=K?++tt:--tt)L[p]=b[p];for(h=0,W=n,n-=1;W-- >=0;)if(0!=(x=e+.5|0)){for(x>256&&(x=256),c=x+x+1,X=Y-1,f=g-1,H=(T=x+1)*(T+1)/2,O=void 0,N=G=new P,p=et=1;1<=c?et<c:et>c;p=1<=c?++et:--et)N=N.next=new P,p===T&&(O=N);for(N.next=G,J=null,q=null,$=Q=0,D=I[x],j=B[x],Z=it=0;0<=g?it<g:it>g;Z=0<=g?++it:--it){for(k=u=r=E=d=s=0,F=T*(C=L[Q]),l=T*(S=L[Q+1]),o=T*(R=L[Q+2]),E+=H*C,d+=H*S,s+=H*R,N=G,p=nt=0;0<=T?nt<T:nt>T;p=0<=T?++nt:--nt)N.r=C,N.g=S,N.b=R,N=N.next;for(p=rt=1;1<=T?rt<T:rt>T;p=1<=T?++rt:--rt)E+=(N.r=C=L[M=Q+((X<p?X:p)<<2)])*(A=T-p),d+=(N.g=S=L[M+1])*A,s+=(N.b=R=L[M+2])*A,k+=C,u+=S,r+=R,N=N.next;for(J=G,q=O,V=ot=0;0<=Y?ot<Y:ot>Y;V=0<=Y?++ot:--ot)L[Q]=E*D>>j,L[Q+1]=d*D>>j,L[Q+2]=s*D>>j,E-=F,d-=l,s-=o,F-=J.r,l-=J.g,o-=J.b,M=$+((M=V+T)<X?M:X)<<2,E+=k+=J.r=L[M],d+=u+=J.g=L[M+1],s+=r+=J.b=L[M+2],J=J.next,F+=C=q.r,l+=S=q.g,o+=R=q.b,k-=C,u-=S,r-=R,q=q.next,Q+=4;$+=Y}for(V=st=0;0<=Y?st<Y:st>Y;V=0<=Y?++st:--st){for(u=r=k=d=s=E=0,F=T*(C=L[Q=V<<2]),l=T*(S=L[Q+1]),o=T*(R=L[Q+2]),E+=H*C,d+=H*S,s+=H*R,N=G,p=at=0;0<=T?at<T:at>T;p=0<=T?++at:--at)N.r=C,N.g=S,N.b=R,N=N.next;for(_=Y,p=ht=1;1<=T?ht<T:ht>T;p=1<=T?++ht:--ht)E+=(N.r=C=L[Q=_+V<<2])*(A=T-p),d+=(N.g=S=L[Q+1])*A,s+=(N.b=R=L[Q+2])*A,k+=C,u+=S,r+=R,N=N.next,p<f&&(_+=Y);for(Q=V,J=G,q=O,Z=ct=0;0<=g?ct<g:ct>g;Z=0<=g?++ct:--ct)L[M=Q<<2]=E*D>>j,L[M+1]=d*D>>j,L[M+2]=s*D>>j,E-=F,d-=l,s-=o,F-=J.r,l-=J.g,o-=J.b,M=V+((M=Z+T)<f?M:f)*Y<<2,E+=k+=J.r=L[M],d+=u+=J.g=L[M+1],s+=r+=J.b=L[M+2],J=J.next,F+=C=q.r,l+=S=q.g,o+=R=q.b,k-=C,u-=S,r-=R,q=q.next,Q+=Y}for(e*=i,p=U;--p>-1;)(v=0|(w=(255&z[2+(y=p<<2)])/255*n))===h?(b[y]=b[y]*(m=256-(a=256*(w-(0|w))))+L[y]*a>>8,b[y+1]=b[y+1]*m+L[y+1]*a>>8,b[y+2]=b[y+2]*m+L[y+2]*a>>8):v===h+1&&(b[y]=L[y],b[y+1]=L[y+1],b[y+2]=L[y+2]);h++}return this}),r.Filter.register("tiltShift",function(t){var e;return(t=x.extend({center:{x:this.dimensions.width/2,y:this.dimensions.height/2},angle:45,focusWidth:200,startRadius:3,radiusFactor:1.5,steps:3},t)).angle*=Math.PI/180,e=R(this.dimensions.width,this.dimensions.height,t.center.x,t.center.y,t.angle,t.focusWidth,!0),this.processPlugin("compoundBlur",[e,t.startRadius,t.radiusFactor,t.steps])}),r.Filter.register("radialBlur",function(t){var e;return(t=x.extend({size:50,center:{x:this.dimensions.width/2,y:this.dimensions.height/2},startRadius:3,radiusFactor:1.5,steps:3,radius:null},t)).radius||(t.radius=this.dimensions.width<this.dimensions.height?this.dimensions.height:this.dimensions.width),e=S(this.dimensions.width,this.dimensions.height,t.center.x,t.center.y,t.radius/2-t.size,t.radius/2),this.processPlugin("compoundBlur",[e,t.startRadius,t.radiusFactor,t.steps])}),r.Filter.register("edgeEnhance",function(){return this.processKernel("Edge Enhance",[0,0,0,-1,1,0,0,0,0])}),r.Filter.register("edgeDetect",function(){return this.processKernel("Edge Detect",[-1,-1,-1,-1,8,-1,-1,-1,-1])}),r.Filter.register("emboss",function(){return this.processKernel("Emboss",[-2,-1,0,-1,1,1,0,1,2])}),r.Filter.register("posterize",function(t){var e,i;return e=256/t,i=255/(t-1),this.process("posterize",function(t){return t.r=Math.floor(Math.floor(t.r/e)*i),t.g=Math.floor(Math.floor(t.g/e)*i),t.b=Math.floor(Math.floor(t.b/e)*i),t})}),r.Filter.register("vintage",function(t){if(null==t&&(t=!0),this.greyscale(),this.contrast(5),this.noise(3),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.87),t)return this.vignette("40%",30)}),r.Filter.register("lomo",function(t){return null==t&&(t=!0),this.brightness(15),this.exposure(15),this.curves("rgb",[0,0],[200,0],[155,255],[255,255]),this.saturation(-20),this.gamma(1.8),t&&this.vignette("50%",60),this.brightness(5)}),r.Filter.register("clarity",function(t){return null==t&&(t=!1),this.vibrance(20),this.curves("rgb",[5,0],[130,150],[190,220],[250,255]),this.sharpen(15),this.vignette("45%",20),t&&(this.greyscale(),this.contrast(4)),this}),r.Filter.register("sinCity",function(){return this.contrast(100),this.brightness(15),this.exposure(10),this.posterize(80),this.clip(30),this.greyscale()}),r.Filter.register("sunrise",function(){return this.exposure(3.5),this.saturation(-5),this.vibrance(50),this.sepia(60),this.colorize("#e87b22",10),this.channels({red:8,blue:8}),this.contrast(5),this.gamma(1.2),this.vignette("55%",25)}),r.Filter.register("crossProcess",function(){return this.exposure(5),this.colorize("#e87b22",4),this.sepia(20),this.channels({blue:8,red:3}),this.curves("b",[0,0],[100,150],[180,180],[255,255]),this.contrast(15),this.vibrance(75),this.gamma(1.6)}),r.Filter.register("orangePeel",function(){return this.curves("rgb",[0,0],[100,50],[140,200],[255,255]),this.vibrance(-30),this.saturation(-30),this.colorize("#ff9000",30),this.contrast(-5),this.gamma(1.4)}),r.Filter.register("love",function(){return this.brightness(5),this.exposure(8),this.contrast(4),this.colorize("#c42007",30),this.vibrance(50),this.gamma(1.3)}),r.Filter.register("grungy",function(){return this.gamma(1.5),this.clip(25),this.saturation(-60),this.contrast(5),this.noise(5),this.vignette("50%",30)}),r.Filter.register("jarques",function(){return this.saturation(-35),this.curves("b",[20,0],[90,120],[186,144],[255,230]),this.curves("r",[0,0],[144,90],[138,120],[255,255]),this.curves("g",[10,0],[115,105],[148,100],[255,248]),this.curves("rgb",[0,0],[120,100],[128,140],[255,255]),this.sharpen(20)}),r.Filter.register("pinhole",function(){return this.greyscale(),this.sepia(10),this.exposure(10),this.contrast(15),this.vignette("60%",35)}),r.Filter.register("oldBoot",function(){return this.saturation(-20),this.vibrance(-50),this.gamma(1.1),this.sepia(30),this.channels({red:-10,blue:5}),this.curves("rgb",[0,0],[80,50],[128,230],[255,255]),this.vignette("60%",30)}),r.Filter.register("glowingSun",function(t){if(null==t&&(t=!0),this.brightness(10),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.gamma(.8),this.filter.contrast(50),this.filter.exposure(10)}),this.newLayer(function(){return this.setBlendingMode("softLight"),this.opacity(80),this.fillColor("#f49600")}),this.exposure(20),this.gamma(.8),t)return this.vignette("45%",20)}),r.Filter.register("hazyDays",function(){return this.gamma(1.2),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(60),this.copyParent(),this.filter.channels({red:5}),this.filter.stackBlur(15)}),this.newLayer(function(){return this.setBlendingMode("addition"),this.opacity(40),this.fillColor("#6899ba")}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(35),this.copyParent(),this.filter.brightness(40),this.filter.vibrance(40),this.filter.exposure(30),this.filter.contrast(15),this.filter.curves("r",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("g",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("b",[0,40],[128,128],[128,128],[255,215]),this.filter.stackBlur(5)}),this.curves("r",[20,0],[128,158],[128,128],[235,255]),this.curves("g",[20,0],[128,128],[128,128],[235,255]),this.curves("b",[20,0],[128,108],[128,128],[235,255]),this.vignette("45%",20)}),r.Filter.register("herMajesty",function(){return this.brightness(40),this.colorize("#ea1c5d",10),this.curves("b",[0,10],[128,180],[190,190],[255,255]),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(50),this.copyParent(),this.filter.gamma(.7),this.newLayer(function(){return this.setBlendingMode("normal"),this.opacity(60),this.fillColor("#ea1c5d")})}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(60),this.copyParent(),this.filter.saturation(50),this.filter.hue(90),this.filter.contrast(10)}),this.gamma(1.4),this.vibrance(-30),this.newLayer(function(){return this.opacity(10),this.fillColor("#e5f0ff")}),this}),r.Filter.register("nostalgia",function(){return this.saturation(20),this.gamma(1.4),this.greyscale(),this.contrast(5),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.8),this.contrast(5),this.exposure(10),this.newLayer(function(){return this.setBlendingMode("overlay"),this.copyParent(),this.opacity(55),this.filter.stackBlur(10)}),this.vignette("50%",30)}),r.Filter.register("hemingway",function(){return this.greyscale(),this.contrast(10),this.gamma(.9),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(40),this.copyParent(),this.filter.exposure(15),this.filter.contrast(15),this.filter.channels({green:10,red:5})}),this.sepia(30),this.curves("rgb",[0,10],[120,90],[180,200],[235,255]),this.channels({red:5,green:-2}),this.exposure(15)}),r.Filter.register("concentrate",function(){return this.sharpen(40),this.saturation(-50),this.channels({red:3}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.sharpen(5),this.filter.contrast(50),this.filter.exposure(10),this.filter.channels({blue:5})}),this.brightness(10)}),function(){var t,e,i;e=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],i=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],t=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},r.Plugin.register("stackBlur",function(n){var r,o,s,a,h,c,u,l,d,g,f,p,m,y,b,v,x,w,D,M,P,R,S,I,B,L,C,k,F,E,z,T,A,j,N,O,J,q,G,W,H,U,K,Y;if(!(isNaN(n)||n<1)){for(b=this.pixelData,a=(n|=0)+n+1,E=(F=this.dimensions.width)-1,d=(l=this.dimensions.height)-1,k=(M=n+1)*(M+1)/2,S=C=new t,g=O=1;1<=a?O<a:O>a;g=1<=a?++O:--O)S=S.next=new t,g===M&&(I=S);for(S.next=C,B=null,L=null,N=A=0,f=e[n],R=i[n],T=J=0;0<=l?J<l:J>l;T=0<=l?++J:--J){for(x=h=r=D=u=s=0,w=M*(v=b[A]),c=M*(y=b[A+1]),o=M*(m=b[A+2]),D+=k*v,u+=k*y,s+=k*m,S=C,g=q=0;0<=M?q<M:q>M;g=0<=M?++q:--q)S.r=v,S.g=y,S.b=m,S=S.next;for(g=G=1;1<=M?G<M:G>M;g=1<=M?++G:--G)D+=(S.r=v=b[p=A+((E<g?E:g)<<2)])*(P=M-g),u+=(S.g=y=b[p+1])*P,s+=(S.b=m=b[p+2])*P,x+=v,h+=y,r+=m,S=S.next;for(B=C,L=I,z=W=0;0<=F?W<F:W>F;z=0<=F?++W:--W)b[A]=D*f>>R,b[A+1]=u*f>>R,b[A+2]=s*f>>R,D-=w,u-=c,s-=o,w-=B.r,c-=B.g,o-=B.b,p=N+((p=z+n+1)<E?p:E)<<2,D+=x+=B.r=b[p],u+=h+=B.g=b[p+1],s+=r+=B.b=b[p+2],B=B.next,w+=v=L.r,c+=y=L.g,o+=m=L.b,x-=v,h-=y,r-=m,L=L.next,A+=4;N+=F}for(z=H=0;0<=F?H<F:H>F;z=0<=F?++H:--H){for(h=r=x=u=s=D=0,w=M*(v=b[A=z<<2]),c=M*(y=b[A+1]),o=M*(m=b[A+2]),D+=k*v,u+=k*y,s+=k*m,S=C,g=U=0;0<=M?U<M:U>M;g=0<=M?++U:--U)S.r=v,S.g=y,S.b=m,S=S.next;for(j=F,g=K=1;1<=n?K<=n:K>=n;g=1<=n?++K:--K)D+=(S.r=v=b[A=j+z<<2])*(P=M-g),u+=(S.g=y=b[A+1])*P,s+=(S.b=m=b[A+2])*P,x+=v,h+=y,r+=m,S=S.next,g<d&&(j+=F);for(A=z,B=C,L=I,T=Y=0;0<=l?Y<l:Y>l;T=0<=l?++Y:--Y)b[p=A<<2]=D*f>>R,b[p+1]=u*f>>R,b[p+2]=s*f>>R,D-=w,u-=c,s-=o,w-=B.r,c-=B.g,o-=B.b,p=z+((p=T+M)<d?p:d)*F<<2,D+=x+=B.r=b[p],u+=h+=B.g=b[p+1],s+=r+=B.b=b[p+2],B=B.next,w+=v=L.r,c+=y=L.g,o+=m=L.b,x-=v,h-=y,r-=m,L=L.next,A+=F}return this}}),r.Filter.register("stackBlur",function(t){return this.processPlugin("stackBlur",[t])})}(),r.Filter.register("threshold",function(t){return this.process("threshold",function(e){return.2126*e.r+.7152*e.g+.0722*e.b<t?(e.r=0,e.g=0,e.b=0):(e.r=255,e.g=255,e.b=255),e})})}).call(this),function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).panzoom=t()}(function(){return function t(e,i,n){function r(s,a){if(!i[s]){if(!e[s]){var h="function"==typeof require&&require;if(!a&&h)return h(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[s]={exports:{}};e[s][0].call(u.exports,function(t){return r(e[s][1][t]||t)},u,u.exports,t,e,i,n)}return i[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)r(n[s]);return r}({1:[function(t,e,i){"use strict";var n=t("wheel"),r=t("amator"),o=t("ngraph.events"),s=t("./lib/kinetic.js"),a=t("./lib/textSelectionInterceptor.js")(),h=t("./lib/transform.js"),c=t("./lib/svgController.js"),u=t("./lib/domController.js"),l=.065,d=1.75,g=300;function f(t,e){var i=(e=e||{}).controller;if(i||(t instanceof SVGElement&&(i=c(t,e)),t instanceof HTMLElement&&(i=u(t,e))),!i)throw new Error("Cannot create panzoom for the current type of dom element");var f=i.getOwner(),b={x:0,y:0},v=!1,x=new h;i.initTransform&&i.initTransform(x);var w,D="function"==typeof e.filterKey?e.filterKey:p,M="number"==typeof e.pinchSpeed?e.pinchSpeed:1,P=e.bounds,R="number"==typeof e.maxZoom?e.maxZoom:Number.POSITIVE_INFINITY,S="number"==typeof e.minZoom?e.minZoom:0,I="number"==typeof e.boundsPadding?e.boundsPadding:.05,B="number"==typeof e.zoomDoubleClickSpeed?e.zoomDoubleClickSpeed:d,L=e.beforeWheel||p,C="number"==typeof e.zoomSpeed?e.zoomSpeed:l;!function(t){var e=typeof t;if("undefined"!==e&&"boolean"!==e&&!(m(t.left)&&m(t.top)&&m(t.bottom)&&m(t.right)))throw new Error("Bounds object is not valid. It can be: undefined, boolean (true|false) or an object {left, top, right, bottom}")}(P),e.autocenter&&function(){var t,e,n=0,r=0,o=Y();if(o)n=o.left,r=o.top,t=o.right-o.left,e=o.bottom-o.top;else{var s=f.getBoundingClientRect();t=s.width,e=s.height}var a=i.getBBox();if(0!==a.width&&0!==a.height){var h=Math.min(t/a.width,e/a.height);x.x=-(a.left+a.width/2)*h+t/2+n,x.y=-(a.top+a.height/2)*h+e/2+r,x.scale=h}}();var k,F,E,z,T,A,j,N=0,O=!1,J=!1;z="smoothScroll"in e&&!e.smoothScroll?{start:p,stop:p,cancel:p}:s(function(){return{x:x.x,y:x.y}},function(t,e){yt(),H(t,e)},e.smoothScroll);var q=!1;_();var G={dispose:function(){$()},moveBy:Q,moveTo:H,centerOn:function(t){var e=t.ownerSVGElement;if(!e)throw new Error("ui element is required to be within the scene");var i=t.getBoundingClientRect(),n=i.left+i.width/2,r=i.top+i.height/2,o=e.getBoundingClientRect();Q(o.width/2-n,o.height/2-r,!0)},zoomTo:mt,zoomAbs:Z,smoothZoom:pt,getTransform:function(){return x},showRectangle:function(t){var e=f.getBoundingClientRect(),i=W(e.width,e.height),n=t.right-t.left,r=t.bottom-t.top;if(!Number.isFinite(n)||!Number.isFinite(r))throw new Error("Invalid rectangle");var o=Math.min(i.x/n,i.y/r);x.x=-(t.left+n/2)*o+i.x/2,x.y=-(t.top+r/2)*o+i.y/2,x.scale=o},pause:function(){$(),q=!0},resume:function(){q&&(_(),q=!1)},isPaused:function(){return q}};return o(G),G;function W(t,e){if(i.getScreenCTM){var n=i.getScreenCTM(),r=n.d,o=n.f;b.x=t*n.a-n.e,b.y=e*r-o}else b.x=t,b.y=e;return b}function H(t,e){x.x=t,x.y=e,K(),wt("pan"),X()}function U(t,e){H(x.x+t,x.y+e)}function K(){var t=Y();if(t){var e,n,r=!1,o={left:(n={x:(e=i.getBBox()).left*x.scale+x.x,y:e.top*x.scale+x.y}).x,top:n.y,right:e.width*x.scale+n.x,bottom:e.height*x.scale+n.y},s=t.left-o.right;return s>0&&(x.x+=s,r=!0),(s=t.right-o.left)<0&&(x.x+=s,r=!0),(s=t.top-o.bottom)>0&&(x.y+=s,r=!0),(s=t.bottom-o.top)<0&&(x.y+=s,r=!0),r}}function Y(){if(P){if("boolean"==typeof P){var t=f.getBoundingClientRect(),e=t.width,i=t.height;return{left:e*I,top:i*I,right:e*(1-I),bottom:i*(1-I)}}return P}}function X(){v=!0,w=window.requestAnimationFrame(tt)}function V(t,e,i){if(y(t)||y(e)||y(i))throw new Error("zoom requires valid numbers");var n=x.scale*i;if(n<S){if(x.scale===S)return;i=S/x.scale}if(n>R){if(x.scale===R)return;i=R/x.scale}var r=W(t,e);x.x=r.x-i*(r.x-x.x),x.y=r.y-i*(r.y-x.y),K()||(x.scale*=i),wt("zoom"),X()}function Z(t,e,i){V(t,e,i/x.scale)}function Q(t,e,i){if(!i)return U(t,e);T&&T.cancel();var n=0,o=0;T=r({x:0,y:0},{x:t,y:e},{step:function(t){U(t.x-n,t.y-o),n=t.x,o=t.y}})}function _(){f.addEventListener("mousedown",ht),f.addEventListener("dblclick",at),f.addEventListener("touchstart",it),f.addEventListener("keydown",et),n.addWheelListener(f,gt),X()}function $(){n.removeWheelListener(f,gt),f.removeEventListener("mousedown",ht),f.removeEventListener("keydown",et),f.removeEventListener("dblclick",at),f.removeEventListener("touchstart",it),w&&(window.cancelAnimationFrame(w),w=0),z.cancel(),lt(),dt(),xt()}function tt(){v&&(v=!1,i.applyTransform(x),wt("transform"),w=0)}function et(t){var e=0,i=0,n=0;if(38===t.keyCode?i=1:40===t.keyCode?i=-1:37===t.keyCode?e=1:39===t.keyCode?e=-1:189===t.keyCode||109===t.keyCode?n=1:187!==t.keyCode&&107!==t.keyCode||(n=-1),!D(t,e,i,n)){if(e||i){t.preventDefault(),t.stopPropagation();var r=f.getBoundingClientRect(),o=Math.min(r.width,r.height);Q(.05*o*e,.05*o*i)}if(n){var s=bt(n),a=f.getBoundingClientRect();mt(a.width/2,a.height/2,s)}}}function it(t){if(function(t){e.onTouch&&!e.onTouch(t)||(t.stopPropagation(),t.preventDefault())}(t),1===t.touches.length)return function(t){var e=ft(t.touches[0]);k=e.x,F=e.y,z.cancel(),nt()}(t);2===t.touches.length&&(E=st(t.touches[0],t.touches[1]),j=!0,nt())}function nt(){O||(O=!0,document.addEventListener("touchmove",rt),document.addEventListener("touchend",ot),document.addEventListener("touchcancel",ot))}function rt(t){if(1===t.touches.length){t.stopPropagation();var e=ft(t.touches[0]),i=e.x-k,n=e.y-F;0!==i&&0!==n&&vt(),k=e.x,F=e.y;var r=W(i,n);Q(r.x,r.y)}else if(2===t.touches.length){j=!0;var o=t.touches[0],s=t.touches[1],a=st(o,s);mt(k=(o.clientX+s.clientX)/2,F=(o.clientY+s.clientY)/2,1+(a/E-1)*M),E=a,t.stopPropagation(),t.preventDefault()}}function ot(t){if(t.touches.length>0){var e=ft(t.touches[0]);k=e.x,F=e.y}else{var i=new Date;i-N<g&&pt(k,F,B),N=i,O=!1,xt(),dt()}}function st(t,e){var i=t.clientX-e.clientX,n=t.clientY-e.clientY;return Math.sqrt(i*i+n*n)}function at(t){!function(t){e.onDoubleClick&&!e.onDoubleClick(t)||(t.preventDefault(),t.stopPropagation())}(t);var i=ft(t);pt(i.x,i.y,B)}function ht(t){if(O)return t.stopPropagation(),!1;if(1===t.button&&null!==window.event||0===t.button){z.cancel();var e=ft(t),i=W(e.x,e.y);return k=i.x,F=i.y,document.addEventListener("mousemove",ct),document.addEventListener("mouseup",ut),a.capture(t.target||t.srcElement),!1}}function ct(t){if(!O){vt();var e=ft(t),i=W(e.x,e.y),n=i.x-k,r=i.y-F;k=i.x,F=i.y,Q(n,r)}}function ut(){a.release(),xt(),lt()}function lt(){document.removeEventListener("mousemove",ct),document.removeEventListener("mouseup",ut),J=!1}function dt(){document.removeEventListener("touchmove",rt),document.removeEventListener("touchend",ot),document.removeEventListener("touchcancel",ot),J=!1,j=!1}function gt(t){if(!L(t)){z.cancel();var e=bt(t.deltaY);if(1!==e){var i=ft(t);mt(i.x,i.y,e),t.preventDefault()}}}function ft(t){var e=f.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}function pt(t,e,i){var n=x.scale,o={scale:n},s={scale:i*n};z.cancel(),yt(),A=r(o,s,{step:function(i){Z(t,e,i.scale)}})}function mt(t,e,i){return z.cancel(),yt(),V(t,e,i)}function yt(){A&&(A.cancel(),A=null)}function bt(t){var e=1;return t>0?e=1-C:t<0&&(e=1+C),e}function vt(){J||(wt("panstart"),J=!0,z.start())}function xt(){J&&(j||z.stop(),wt("panend"))}function wt(t){G.fire(t,G)}}function p(){}function m(t){return Number.isFinite(t)}function y(t){return Number.isNaN?Number.isNaN(t):t!=t}e.exports=f,function(){if("undefined"!=typeof document){var t,e=document.getElementsByTagName("script");if(e&&(Array.from(e).forEach(function(e){e.src&&e.src.match(/\bpanzoom(\.min)?\.js/)&&(t=e)}),t)){var i=t.getAttribute("query");if(i){var n=t.getAttribute("name")||"pz",r=Date.now();!function e(){var s=document.querySelector(i);if(!s)return Date.now()-r<2e3?void setTimeout(e,100):void console.error("Cannot find the panzoom element",n);var a=function(e){for(var i=t.attributes,n={},r=0;r<i.length;++r){var s=o(i[r]);s&&(n[s.name]=s.value)}return n}();console.log(a),window[n]=f(s,a)}()}}}function o(t){if(t.name&&"p"===t.name[0]&&"z"===t.name[1]&&"-"===t.name[2])return{name:t.name.substr(3),value:JSON.parse(t.value)}}}()},{"./lib/domController.js":2,"./lib/kinetic.js":3,"./lib/svgController.js":4,"./lib/textSelectionInterceptor.js":5,"./lib/transform.js":6,amator:7,"ngraph.events":9,wheel:10}],2:[function(t,e,i){e.exports=function(t,e){if(!(t instanceof HTMLElement))throw new Error("svg element is required for svg.panzoom to work");var i=t.parentElement;if(!i)throw new Error("Do not apply panzoom to the detached DOM element. ");return t.scrollTop=0,e.disableKeyboardInteraction||i.setAttribute("tabindex",0),{getBBox:function(){return{left:0,top:0,width:t.clientWidth,height:t.clientHeight}},getOwner:function(){return i},applyTransform:function(e){t.style.transformOrigin="0 0 0",t.style.transform="matrix("+e.scale+", 0, 0, "+e.scale+", "+e.x+", "+e.y+")"}}}},{}],3:[function(t,e,i){e.exports=function(t,e,i){"object"!=typeof i&&(i={});var n,r,o,s,a,h,c,u,l,d,g="number"==typeof i.minVelocity?i.minVelocity:5,f="number"==typeof i.amplitude?i.amplitude:.25,p=342;return{start:function(){n=t(),h=l=s=c=0,r=new Date,window.clearInterval(o),window.cancelAnimationFrame(d),o=window.setInterval(m,100)},stop:function(){window.clearInterval(o),window.cancelAnimationFrame(d);var e=t();a=e.x,u=e.y,r=Date.now(),(s<-g||s>g)&&(a+=h=f*s),(c<-g||c>g)&&(u+=l=f*c),d=window.requestAnimationFrame(y)},cancel:function(){window.clearInterval(o),window.cancelAnimationFrame(d)}};function m(){var e=Date.now(),i=e-r;r=e;var o=t(),a=o.x-n.x,h=o.y-n.y;n=o;var u=1e3/(1+i);s=.8*a*u+.2*s,c=.8*h*u+.2*c}function y(){var t=Date.now()-r,i=!1,n=0,o=0;h&&((n=-h*Math.exp(-t/p))>.5||n<-.5?i=!0:n=h=0),l&&((o=-l*Math.exp(-t/p))>.5||o<-.5?i=!0:o=l=0),i&&(e(a+n,u+o),d=window.requestAnimationFrame(y))}}},{}],4:[function(t,e,i){e.exports=function(t,e){if(!(t instanceof SVGElement))throw new Error("svg element is required for svg.panzoom to work");var i=t.ownerSVGElement;if(!i)throw new Error("Do not apply panzoom to the root <svg> element. Use its child instead (e.g. <g></g>). As of March 2016 only FireFox supported transform on the root element");return e.disableKeyboardInteraction||i.setAttribute("tabindex",0),{getBBox:function(){var e=t.getBBox();return{left:e.x,top:e.y,width:e.width,height:e.height}},getScreenCTM:function(){return i.getScreenCTM()},getOwner:function(){return i},applyTransform:function(e){t.setAttribute("transform","matrix("+e.scale+" 0 0 "+e.scale+" "+e.x+" "+e.y+")")},initTransform:function(e){var n=t.getScreenCTM();e.x=n.e,e.y=n.f,e.scale=n.a,i.removeAttributeNS(null,"viewBox")}}}},{}],5:[function(t,e,i){function n(t){return t.stopPropagation(),!1}e.exports=function(){var t,e,i;return{capture:function(r){e=window.document.onselectstart,i=window.document.ondragstart,window.document.onselectstart=n,(t=r).ondragstart=n},release:function(){window.document.onselectstart=e,t&&(t.ondragstart=i)}}}},{}],6:[function(t,e,i){e.exports=function(){this.x=0,this.y=0,this.scale=1}},{}],7:[function(t,e,i){var n=t("bezier-easing"),r={ease:n(.25,.1,.25,1),easeIn:n(.42,0,1,1),easeOut:n(0,0,.58,1),easeInOut:n(.42,0,.58,1),linear:n(0,0,1,1)};function o(){}function s(){var t=new Set,e=new Set,i=0;return{next:n,cancel:n,clearAll:function(){t.clear(),e.clear(),cancelAnimationFrame(i),i=0}};function n(t){e.add(t),i||(i=requestAnimationFrame(r))}function r(){i=0;var n=e;e=t,(t=n).forEach(function(t){t()}),t.clear()}}e.exports=function(t,e,i){var n=Object.create(null),s=Object.create(null),a="function"==typeof(i=i||{}).easing?i.easing:r[i.easing];a||(i.easing&&console.warn("Unknown easing function in amator: "+i.easing),a=r.ease);var h="function"==typeof i.step?i.step:o,c="function"==typeof i.done?i.done:o,u=function(t){if(!t)return"undefined"!=typeof window&&window.requestAnimationFrame?{next:window.requestAnimationFrame.bind(window),cancel:window.cancelAnimationFrame.bind(window)}:{next:function(t){return setTimeout(t,1e3/60)},cancel:function(t){return clearTimeout(t)}};if("function"!=typeof t.next)throw new Error("Scheduler is supposed to have next(cb) function");if("function"!=typeof t.cancel)throw new Error("Scheduler is supposed to have cancel(handle) function");return t}(i.scheduler),l=Object.keys(e);l.forEach(function(i){n[i]=t[i],s[i]=e[i]-t[i]});var d,g=Math.max(1,.06*("number"==typeof i.duration?i.duration:400)),f=0;return d=u.next(function e(){var i=a(f/g);f+=1,function(e){l.forEach(function(i){t[i]=s[i]*e+n[i]})}(i),f<=g?(d=u.next(e),h(t)):(d=0,setTimeout(function(){c(t)},0))}),{cancel:function(){u.cancel(d),d=0}}},e.exports.makeAggregateRaf=s,e.exports.sharedScheduler=s()},{"bezier-easing":8}],8:[function(t,e,i){var n="function"==typeof Float32Array;function r(t,e){return 1-3*e+3*t}function o(t,e){return 3*e-6*t}function s(t){return 3*t}function a(t,e,i){return((r(e,i)*t+o(e,i))*t+s(e))*t}function h(t,e,i){return 3*r(e,i)*t*t+2*o(e,i)*t+s(e)}function c(t){return t}e.exports=function(t,e,i,r){if(!(0<=t&&t<=1&&0<=i&&i<=1))throw new Error("bezier x values must be in [0, 1] range");if(t===e&&i===r)return c;for(var o=n?new Float32Array(11):new Array(11),s=0;s<11;++s)o[s]=a(.1*s,t,i);return function(n){return 0===n?0:1===n?1:a(function(e){for(var n=0,r=1;10!==r&&o[r]<=e;++r)n+=.1;var s=n+(e-o[--r])/(o[r+1]-o[r])*.1,c=h(s,t,i);return c>=.001?function(t,e,i,n){for(var r=0;r<4;++r){var o=h(e,i,n);if(0===o)return e;e-=(a(e,i,n)-t)/o}return e}(e,s,t,i):0===c?s:function(t,e,i,n,r){var o,s,h=0;do{(o=a(s=e+(i-e)/2,n,r)-t)>0?i=s:e=s}while(Math.abs(o)>1e-7&&++h<10);return s}(e,n,n+.1,t,i)}(n),e,r)}}},{}],9:[function(t,e,i){e.exports=function(t){!function(t){if(!t)throw new Error("Eventify cannot use falsy object as events subject");for(var e=["on","fire","off"],i=0;i<e.length;++i)if(t.hasOwnProperty(e[i]))throw new Error("Subject cannot be eventified, since it already has property '"+e[i]+"'")}(t);var e=function(t){var e=Object.create(null);return{on:function(i,n,r){if("function"!=typeof n)throw new Error("callback is expected to be a function");var o=e[i];return o||(o=e[i]=[]),o.push({callback:n,ctx:r}),t},off:function(i,n){if(void 0===i)return e=Object.create(null),t;if(e[i])if("function"!=typeof n)delete e[i];else for(var r=e[i],o=0;o<r.length;++o)r[o].callback===n&&r.splice(o,1);return t},fire:function(i){var n,r=e[i];if(!r)return t;arguments.length>1&&(n=Array.prototype.splice.call(arguments,1));for(var o=0;o<r.length;++o){var s=r[o];s.callback.apply(s.ctx,n)}return t}}}(t);return t.on=e.on,t.off=e.off,t.fire=e.fire,t}},{}],10:[function(t,e,i){e.exports=a,e.exports.addWheelListener=a,e.exports.removeWheelListener=function(t,e,i){c(t,o,e,i),"DOMMouseScroll"==o&&c(t,"MozMousePixelScroll",e,i)};var n,r,o,s="";function a(t,e,i){h(t,o,e,i),"DOMMouseScroll"==o&&h(t,"MozMousePixelScroll",e,i)}function h(t,e,i,r){t[n](s+e,"wheel"==o?i:function(t){!t&&(t=window.event);var e={originalEvent:t,target:t.target||t.srcElement,type:"wheel",deltaMode:"MozMousePixelScroll"==t.type?0:1,deltaX:0,deltaY:0,deltaZ:0,clientX:t.clientX,clientY:t.clientY,preventDefault:function(){t.preventDefault?t.preventDefault():t.returnValue=!1},stopPropagation:function(){t.stopPropagation&&t.stopPropagation()},stopImmediatePropagation:function(){t.stopImmediatePropagation&&t.stopImmediatePropagation()}};return"mousewheel"==o?(e.deltaY=-.025*t.wheelDelta,t.wheelDeltaX&&(e.deltaX=-.025*t.wheelDeltaX)):e.deltaY=t.detail,i(e)},r||!1)}function c(t,e,i,n){t[r](s+e,i,n||!1)}!function(t,e){t&&t.addEventListener?(n="addEventListener",r="removeEventListener"):(n="attachEvent",r="detachEvent",s="on"),o=e?"onwheel"in e.createElement("div")?"wheel":void 0!==e.onmousewheel?"mousewheel":"DOMMouseScroll":"wheel"}("undefined"!=typeof window&&window,"undefined"!=typeof document&&document)},{}]},{},[1])(1)});